sequenceDiagram
  actor user as User
  participant lb as ğŸ“£ï¸ Load Balancer
  participant rs as ğŸ”„ï¸ Redirect Service
  participant cache as ğŸ”—ï¸ Cache
  participant db as ğŸ”—ï¸ URLs Database
  participant queue as ğŸ“¬ï¸ Events Queue
  user->>lb: GET https://short.ly/ie3Sfk, User-Agent: Chrome
  lb->>rs: GET https://rs.local/ie3Sfk, User-Agent: Chrome
  rs->>cache: GET ie3Sfk
  note over rs,cache: First look for URL in the cache.
  alt This happens in case URL is present in the cache (~80% or requests)
      rect rgb(253, 246, 227)
      cache->>rs: {"id": "ie3Sfk", "url": "https://example.com/long/url", "cretor_id": 12}
      rs->>lb: 301 Moved Permanently, Location: https://example.com/long/url
      lb->>user: 301 Moved Permanently, Location: https://example.com/long/url
      rs-)queue: $timestamp, 'Chrome', 'ie3Sfk', 'https://example.com/long/url', 12
      note over rs,queue: Enqueue redirect event so it can be cached and request rate can be updated.
      end
  else This happens in case URL is absent from the cache (~20% or requests)
      rect rgb(253, 246, 227)
      cache->>rs: null
      rs->>db: SELECT url, creator_id FROM urls WHERE id='ie3Sfk'
      note over rs,db: Fall back to looking for URL in the database.
      alt This happens in case URL is present in the database
          rect rgb(238, 232, 213)
          db->>rs: https://example.com/long/url, 12
          rs->>lb: 301 Moved Permanently, Location: https://example.com/long/url
          lb->>user: 301 Moved Permanently, Location: https://example.com/long/url
          rs-)queue: $timestamp, 'Chrome', 'ie3Sfk', 'https://example.com/long/url', 12
          note over rs,queue: Enqueue redirect event so it can be cached and request rate can be updated.
          end
      else This happens in case URL is absent from the database
          rect rgb(238, 232, 213)
          db->>rs: null
          rs->>lb: 404 Not Found
          lb->>user: 404 Not Found
          end
      end
      end
  end
